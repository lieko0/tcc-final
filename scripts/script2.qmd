```{r}
#| warning: false
library("foreign")
library("tidyverse")
library("caret")
library("kohonen")
library("dplyr")
library("tidyr")
```

```{r}
# ==============================================================================
# FUNÇÕES MODULARES PARA PIPELINE SOM
# ==============================================================================

# 1. Carregar dados
carregar_dados <- function(caminho_tr, caminho_ts, col_inicio_labels) {
    dados_tr <- read.csv(caminho_tr)
    dados_ts <- read.csv(caminho_ts)
    
    resultado <- list(
        tr_attr = as.matrix(dados_tr[, 1:(col_inicio_labels - 1)]),
        tr_labels = as.matrix(dados_tr[, col_inicio_labels:ncol(dados_tr)]),
        ts_attr = as.matrix(dados_ts[, 1:(col_inicio_labels - 1)]),
        ts_labels = as.matrix(dados_ts[, col_inicio_labels:ncol(dados_ts)])
    )
    
    return(resultado)
}

# 2. Criar configurações de grid
criar_grids <- function(xdim, ydim, tipo_funcao = "bubble") {
    if (tipo_funcao == "bubble") {
        grid_rectangular <- somgrid(xdim = xdim, ydim = ydim,
                                   topo = "rectangular",
                                   neighbourhood.fct = "bubble")
        grid_hexagonal <- somgrid(xdim = xdim, ydim = ydim,
                                 topo = "hexagonal",
                                 neighbourhood.fct = "bubble")
        nomes <- c("bubble_rectangular", "bubble_hexagonal")
    } else {
        grid_rectangular <- somgrid(xdim = xdim, ydim = ydim,
                                   topo = "rectangular",
                                   neighbourhood.fct = "gaussian")
        grid_hexagonal <- somgrid(xdim = xdim, ydim = ydim,
                                 topo = "hexagonal",
                                 neighbourhood.fct = "gaussian")
        nomes <- c("gaussian_rectangular", "gaussian_hexagonal")
    }
    
    grids <- list(grid_rectangular, grid_hexagonal)
    names(grids) <- nomes
    return(grids)
}

# 3. Criar grade de parâmetros
criar_param_grid <- function(grids_list,
                            rlen_values = c(500, 1000, 1500),
                            radius_values = c(3, 6, 9),
                            alpha1_values = c(0.5, 0.1, 0.05),
                            alpha2_values = c(0.01, 0.005, 0.001)) {
    
    param_grid <- expand.grid(
        rlen = rlen_values,
        radius = radius_values,
        alpha1 = alpha1_values,
        alpha2 = alpha2_values,
        grid_index = 1:length(grids_list)
    )
    
    return(param_grid)
}

# 4. Treinar modelos SOM
treinar_modelos <- function(X_train, Y_train, X_test, Y_test, 
                           param_grid, grids_list, seed = 1234) {
    set.seed(seed)
    results <- list()
    
    for (i in 1:nrow(param_grid)) {
        params <- param_grid[i, ]
        grid <- grids_list[[params$grid_index]]
        grid_name <- names(grids_list)[params$grid_index]
        
        model <- tryCatch({
            supersom(
                data = list(Y = Y_train),
                grid = grid,
                rlen = params$rlen,
                radius = params$radius,
                alpha = c(params$alpha1, params$alpha2),
                keep.data = TRUE
            )
        }, error = function(e) {
            cat("Erro ao treinar modelo:", e$message, "\n")
            return(NULL)
        })
        
        if (is.null(model)) next
        
        mapped_test <- kohonen::map(model, newdata = list(Y = Y_test))
        qe_test <- mean(mapped_test$distances)
        
        results[[i]] <- list(
            params = params,
            model = model,
            qe_test = qe_test,
            grid_name = grid_name
        )
        
        #cat(sprintf(
        #    "N: %d/%d | Grid: %s | rlen: %d | radius: %d | alpha1: %.3f | alpha2: %.3f | QE: %.4f\n",
        #    i, nrow(param_grid), grid_name, params$rlen, params$radius,
        #    params$alpha1, params$alpha2, qe_test
        #))
    }
    
    return(results)
}

# 5. Selecionar melhor modelo
selecionar_melhor_modelo <- function(results) {
    best_result <- NULL
    best_qe <- Inf
    
    for (res in results) {
        if (!is.null(res) && res$qe_test < best_qe) {
            best_qe <- res$qe_test
            best_result <- res
        }
    }
    
    cat("\n=== MELHOR RESULTADO ===\n")
    cat(sprintf(
        "Grid: %s | rlen: %d | radius: %d | alpha1: %.3f | alpha2: %.3f | QE: %.4f\n",
        best_result$grid_name, best_result$params$rlen, best_result$params$radius,
        best_result$params$alpha1, best_result$params$alpha2, best_result$qe_test
    ))
    
    return(best_result)
}

# 6. Visualizar modelo
visualizar_modelo <- function(model, prefixo_arquivo = "som") {
    plots_tipos <- c("counts", "changes", "dist.neighbours", "quality")
    
    for (tipo in plots_tipos) {
        pdf(paste0(prefixo_arquivo, "_", tipo, ".pdf"), width = 10, height = 10)
        if (tipo == "quality") {
            plot(model, type = tipo, heatkey = TRUE)
        } else {
            plot(model, type = tipo)
        }
        dev.off()
    }
    
    # Códigos com diferentes renderizações
    rendering_tipos <- c("segments", "stars", "lines")
    for (rend in rendering_tipos) {
        pdf(paste0(prefixo_arquivo, "_codes_", rend, ".pdf"), width = 10, height = 10)
        plot(model, type = "codes", codeRendering = rend)
        dev.off()
    }
    
    # Mapping
    pdf(paste0(prefixo_arquivo, "_mapping.pdf"), width = 10, height = 10)
    plot(model, type = "mapping", pchs = 20, heatkey = TRUE)
    dev.off()
    
    cat("Visualizações salvas com prefixo:", prefixo_arquivo, "\n")
}

# 7. Extrair informações do modelo
extrair_informacoes <- function(best_result, X_train) {
    model <- best_result$model
    
    uc <- data.frame(neuron = model$unit.classif)
    data_model <- data.frame(model$data)
    codes <- data.frame(model$codes)
    
    rownames(codes) <- paste0("N", seq_len(nrow(codes)))
    neuron_data <- data.frame(uc, data_model)
    train_dataset <- data.frame(X_train, neuron_data)
    
    neuron_ids <- unique(train_dataset$neuron)
    neuron_dfs <- lapply(neuron_ids, function(n) {
        subset(train_dataset, neuron == n)
    })
    names(neuron_dfs) <- paste0("N", neuron_ids)
    
    return(list(
        codes = codes,
        train_dataset = train_dataset,
        neuron_dataframes = neuron_dfs
    ))
}

# 8. Criar partições hierárquicas
criar_particoes <- function(best_result, xdim, ydim, prefixo_arquivo = "particoes") {
    codes <- data.frame(best_result$model$codes)
    rownames(codes) <- paste0("N", seq_len(nrow(codes)))
    codebook_matrix <- as.matrix(codes)
    
    neuron_num <- xdim * ydim
    neuron <- seq(from = 1, to = neuron_num, by = 1)
    all_partitions <- data.frame(neuron = neuron)
    
    for (k in 2:neuron_num) {
        den <- hclust(dist(codebook_matrix))
        cluster <- cutree(den, k)
        
        # Salvar visualização
        pdf(paste0(prefixo_arquivo, "_k", k, ".pdf"), width = 12, height = 12)
        plot(best_result$model, type = "codes", codeRendering = "segments", bgcol = rainbow(k)[cluster],
             main = paste("SOM - Clusters (k =", k, ")"))
        add.cluster.boundaries(best_result$model, cluster)
        dev.off()
        
        all_partitions[[paste0("partition_", k)]] <- as.numeric(cluster)
    }
    
    cat("Partições criadas de k=2 até k=", neuron_num, "\n")
    return(all_partitions)
}

# 9. Pipeline completa
executar_pipeline <- function(caminho_tr, caminho_ts, col_inicio_labels,
                             xdim = 3, ydim = 3, tipo_funcao = "bubble",
                             rlen_values = c(500, 1000, 1500),
                             radius_values = c(3, 5, 8, 13),
                             alpha1_values = c(0.5, 0.1, 0.05),
                             alpha2_values = c(0.01, 0.005, 0.001),
                             prefixo_saida = "resultado",
                             seed = 1234) {
    
    cat("\n=== INICIANDO PIPELINE SOM ===\n")
    cat("Prefixo de saída:", prefixo_saida, "\n\n")
    
    # 1. Carregar dados
    cat("1. Carregando dados...\n")
    dados <- carregar_dados(caminho_tr, caminho_ts, col_inicio_labels)
    
    # 2. Criar grids
    cat("2. Criando grids...\n")
    grids <- criar_grids(xdim, ydim, tipo_funcao)
    
    # 3. Criar grade de parâmetros
    cat("3. Criando grade de parâmetros...\n")
    param_grid <- criar_param_grid(grids, rlen_values, radius_values, 
                                  alpha1_values, alpha2_values)
    cat("Total de combinações:", nrow(param_grid), "\n\n")
    
    # 4. Treinar modelos
    cat("4. Treinando modelos...\n")
    results <- treinar_modelos(dados$tr_attr, dados$tr_labels,
                              dados$ts_attr, dados$ts_labels,
                              param_grid, grids, seed)
    
    # 5. Selecionar melhor modelo
    cat("\n5. Selecionando melhor modelo...\n")
    best <- selecionar_melhor_modelo(results)
    
    # 6. Visualizar
    cat("\n6. Gerando visualizações...\n")
    visualizar_modelo(best$model, paste0(prefixo_saida, "_viz"))
    
    # 7. Extrair informações
    cat("\n7. Extraindo informações do modelo...\n")
    info <- extrair_informacoes(best, dados$tr_attr)
    
    # 8. Criar partições
    cat("\n8. Criando partições hierárquicas...\n")
    particoes <- criar_particoes(best, xdim, ydim, 
                                paste0(prefixo_saida, "_particoes"))
    
    cat("\n=== PIPELINE CONCLUÍDA ===\n\n")
    
    return(list(
        dados = dados,
        best_result = best,
        all_results = results,
        informacoes = info,
        particoes = particoes
    ))
}
```

```{r}
# ==============================================================================
# EXEMPLO DE USO
# ==============================================================================

# Executar pipeline com configuração padrão - Emotions Dataset - Bubble
resultado.emotions.fold1.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Tr\\emotions-Split-Tr-1.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Ts\\emotions-Split-Ts-1.csv",
    col_inicio_labels = 73,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "emotions_fold1_bubble",
    seed = 1234
)

resultado.emotions.fold2.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Tr\\emotions-Split-Tr-2.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Ts\\emotions-Split-Ts-2.csv",
    col_inicio_labels = 73,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "emotions_fold2_bubble",
    seed = 1234
)


resultado.emotions.fold3.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Tr\\emotions-Split-Tr-3.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Ts\\emotions-Split-Ts-3.csv",
    col_inicio_labels = 73,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "emotions_fold3_bubble",
    seed = 1234
)

# Comparar QE dos melhores modelos
cat("\nComparação de QE:\n")
cat(sprintf("Emotions - Bubble - Fold 1 - QE: %.4f\n", resultado.emotions.fold1.bubble$best_result$qe_test))
cat(sprintf("Emotions - Bubble - Fold 2 - QE: %.4f\n", resultado.emotions.fold2.bubble$best_result$qe_test))
cat(sprintf("Emotions - Bubble - Fold 3 - QE: %.4f\n", resultado.emotions.fold3.bubble$best_result$qe_test))
```

```{r}
# ==============================================================================
# EXEMPLO DE USO
# ==============================================================================

# Executar pipeline com configuração padrão - Emotions Dataset - Gaussian
resultado.emotions.fold1.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Tr\\emotions-Split-Tr-1.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Ts\\emotions-Split-Ts-1.csv",
    col_inicio_labels = 73,
    
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "emotions_fold1_gaussian",
    seed = 1234
)

resultado.emotions.fold2.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Tr\\emotions-Split-Tr-2.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Ts\\emotions-Split-Ts-2.csv",
    col_inicio_labels = 73,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "emotions_fold2_gaussian",
    seed = 1234
)

resultado.emotions.fold3.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Tr\\emotions-Split-Tr-3.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\emotions\\Stratified\\CrossValidation\\Ts\\emotions-Split-Ts-3.csv",
    col_inicio_labels = 73,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "emotions_fold3_gaussian",
    seed = 1234
)

# Comparar QE dos melhores modelos
cat("\nComparação de QE:\n")
cat(sprintf("Emotions - Gaussian - Fold 1 - QE: %.4f\n", resultado.emotions.fold1.gaussian$best_result$qe_test))
cat(sprintf("Emotions - Gaussian - Fold 2 - QE: %.4f\n", resultado.emotions.fold2.gaussian$best_result$qe_test))
cat(sprintf("Emotions - Gaussian - Fold 3 - QE: %.4f\n", resultado.emotions.fold3.gaussian$best_result$qe_test))
```




```{r}
# ==============================================================================
# EXEMPLO DE USO
# ==============================================================================

# Executar pipeline com configuração padrão - Scene Dataset - Bubble
resultado.scene.fold1.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Tr\\scene-Split-Tr-1.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Ts\\scene-Split-Ts-1.csv",
    col_inicio_labels = 295,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "scene_fold1_bubble",
    seed = 1234
)

resultado.scene.fold2.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Tr\\scene-Split-Tr-2.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Ts\\scene-Split-Ts-2.csv",
    col_inicio_labels = 295,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "scene_fold2_bubble",
    seed = 1234
)


resultado.scene.fold3.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Tr\\scene-Split-Tr-3.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Ts\\scene-Split-Ts-3.csv",
    col_inicio_labels = 295,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "scene_fold3_bubble",
    seed = 1234
)

# Comparar QE dos melhores modelos
cat("\nComparação de QE:\n")
cat(sprintf("Scene - Bubble - Fold 1 - QE: %.4f\n", resultado.scene.fold1.bubble$best_result$qe_test))
cat(sprintf("Scene - Bubble - Fold 2 - QE: %.4f\n", resultado.scene.fold2.bubble$best_result$qe_test))
cat(sprintf("Scene - Bubble - Fold 3 - QE: %.4f\n", resultado.scene.fold3.bubble$best_result$qe_test))
```

```{r}
# ==============================================================================
# EXEMPLO DE USO
# ==============================================================================

# Executar pipeline com configuração padrão - Scene Dataset - Gaussian
resultado.scene.fold1.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Tr\\scene-Split-Tr-1.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Ts\\scene-Split-Ts-1.csv",
    col_inicio_labels = 295,
    
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "scene_fold1_gaussian",
    seed = 1234
)

resultado.scene.fold2.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Tr\\scene-Split-Tr-2.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Ts\\scene-Split-Ts-2.csv",
    col_inicio_labels = 295,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "scene_fold2_gaussian",
    seed = 1234
)

resultado.scene.fold3.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Tr\\scene-Split-Tr-3.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\scene\\Stratified\\CrossValidation\\Ts\\scene-Split-Ts-3.csv",
    col_inicio_labels = 295,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "scene_fold3_gaussian",
    seed = 1234
)

# Comparar QE dos melhores modelos
cat("\nComparação de QE:\n")
cat(sprintf("Scene - Gaussian - Fold 1 - QE: %.4f\n", resultado.scene.fold1.gaussian$best_result$qe_test))
cat(sprintf("Scene - Gaussian - Fold 2 - QE: %.4f\n", resultado.scene.fold2.gaussian$best_result$qe_test))
cat(sprintf("Scene - Gaussian - Fold 3 - QE: %.4f\n", resultado.scene.fold3.gaussian$best_result$qe_test))
```






```{r}
# ==============================================================================
# EXEMPLO DE USO
# ==============================================================================

# Executar pipeline com configuração padrão - Flags Dataset - Bubble
resultado.flags.fold1.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Tr\\flags-Split-Tr-1.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Ts\\flags-Split-Ts-1.csv",
    col_inicio_labels = 20,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "flags_fold1_bubble",
    seed = 1234
)

resultado.flags.fold2.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Tr\\flags-Split-Tr-2.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Ts\\flags-Split-Ts-2.csv",
    col_inicio_labels = 20,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "flags_fold2_bubble",
    seed = 1234
)


resultado.flags.fold3.bubble <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Tr\\flags-Split-Tr-3.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Ts\\flags-Split-Ts-3.csv",
    col_inicio_labels = 20,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "bubble",
    prefixo_saida = "flags_fold3_bubble",
    seed = 1234
)

# Comparar QE dos melhores modelos
cat("\nComparação de QE:\n")
cat(sprintf("Flags - Bubble - Fold 1 - QE: %.4f\n", resultado.flags.fold1.bubble$best_result$qe_test))
cat(sprintf("Flags - Bubble - Fold 2 - QE: %.4f\n", resultado.flags.fold2.bubble$best_result$qe_test))
cat(sprintf("Flags - Bubble - Fold 3 - QE: %.4f\n", resultado.flags.fold3.bubble$best_result$qe_test))
```

```{r}
# ==============================================================================
# EXEMPLO DE USO
# ==============================================================================

# Executar pipeline com configuração padrão - Flags Dataset - Gaussian
resultado.flags.fold1.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Tr\\flags-Split-Tr-1.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Ts\\flags-Split-Ts-1.csv",
    col_inicio_labels = 20,
    
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "flags_fold1_gaussian",
    seed = 1234
)

resultado.flags.fold2.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Tr\\flags-Split-Tr-2.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Ts\\flags-Split-Ts-2.csv",
    col_inicio_labels = 20,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "flags_fold2_gaussian",
    seed = 1234
)

resultado.flags.fold3.gaussian <- executar_pipeline(
    caminho_tr = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Tr\\flags-Split-Tr-3.csv",
    caminho_ts = "E:\\git-tcc\\tcc\\data\\flags\\Stratified\\CrossValidation\\Ts\\flags-Split-Ts-3.csv",
    col_inicio_labels = 20,
    xdim = 3,
    ydim = 3,
    tipo_funcao = "gaussian",
    prefixo_saida = "flags_fold3_gaussian",
    seed = 1234
)

# Comparar QE dos melhores modelos
cat("\nComparação de QE:\n")
cat(sprintf("Flags - Gaussian - Fold 1 - QE: %.4f\n", resultado.flags.fold1.gaussian$best_result$qe_test))
cat(sprintf("Flags - Gaussian - Fold 2 - QE: %.4f\n", resultado.flags.fold2.gaussian$best_result$qe_test))
cat(sprintf("Flags - Gaussian - Fold 3 - QE: %.4f\n", resultado.flags.fold3.gaussian$best_result$qe_test))
```